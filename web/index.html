<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Challenge Open Data</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.0/js/bootstrap.min.js"></script>

    <script src="https://d3js.org/d3.v4.min.js"></script>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/javascript.util/0.12.12/javascript.util.min.js"></script>
    <script src="js/jquery-csv/src/jquery.csv.min.js"></script>
    <script src="js/utils.js"></script>
    <link href="indexstyle.css" rel="stylesheet" type="text/css">
    <style>
       .canvas {
           -moz-user-select: none;
           -webkit-user-select: none;
           -ms-user-select: none;
           -margin: auto;
       }

   </style>
</head>


<body>
  <!-- Tab links -->
  <div class="tab">

    <button class="tablinks" onclick="openTab(event, 'Graphe')" id="defaultOpen">Graphes</button>
    <button class="tablinks" onclick="openTab(event, 'Carte')">Carte</button>
    <button class="tablinks" onclick="openTab(event, 'About')">About</button>
  </div>
  <!-- Tab GRAPHE -->
  <div id="Graphe" class="tabcontent">
    <h3>IMC en fonction de l'age</h3>
    <div class="row">
        <div class="col-lg-9">
            <div style="width:100%; text-align: center;">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
         <div class="col-lg-9" style="text-align: center">
            <button type="button" class="btn btn-success" id="display">Display data</button>
        </div>
    </div>
  </div>
  <!-- Tab CARTE -->
  <div id="Carte" class="tabcontent">
    <h3>Carte de l'obésité</h3>
    <link rel="stylesheet" type="text/css" href="css/regions.css">
      <div id="map"></div>
    <script src="js/map.js"></script>

  </div>
  <div id="About" class="tabcontent">
    <h3>Challenge Open Data</h3>
    <p>Projet ENSIMAG 2017-2018</p>
  </div>


  <script type="text/javascript">
  // Get the element with id="defaultOpen" and click on it


    function openTab(evt, tapType) {
      // Declare all variables
      var i, tabcontent, tablinks;

      // Get all elements with class="tabcontent" and hide them
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
      }

      // Get all elements with class="tablinks" and remove the class "active"
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
      }

      // Show the current tab, and add an "active" class to the button that opened the tab
      document.getElementById(tapType).style.display = "block";
      evt.currentTarget.className += " active";
    }
    document.getElementById("defaultOpen").click();


      var personnes = [];

      function Personne(age, bmi) {
          this.x = age;
          this.y = bmi;
      }

      window.onload = function(){
          var scatterChartData = {
              datasets: [{
                  label: "My First dataset",
                  // borderColor: window.chartColors.red,
                  // backgroundColor: color(window.chartColors.red).alpha(0.2).rgbString(),
                  data: []
              }]
          };
          var ctx = document.getElementById("lineChart").getContext("2d");
          window.myScatter = Chart.Scatter(ctx, {
              data: scatterChartData,
              options: {
                  title: {
                      display: true,
                  },
              }
          });

      }
      $(document).ready(function() {
        personnes = [];
        d3.csv("src/Table_indiv.csv", function(data) {
            data.forEach(function(d) {
                d.bmi = +d.bmi;
                d["v2_age"] = +d["v2_age"];
                if(!isNaN(d.bmi) && d.bmi.toString().indexOf('.') != -1 && !isNaN(d.bmi) && d.bmi.toString().indexOf('.') != -1){
                    var personneTemp = new Personne(d["v2_age"], d.bmi);
                    personnes.push(personneTemp);
                }
            });
            personnes.sort(function(a, b) {
                return a.x - b.x;
            })
            makeAverage(personnes);
            myDataIsReady();
        });
      });

      /*
      $("#display").click(function () {
          personnes = [];
          d3.csv("src/Table_indiv.csv", function(data) {
              data.forEach(function(d) {
                  d.bmi = +d.bmi;
                  d["v2_age"] = +d["v2_age"];
                  if(!isNaN(d.bmi) && d.bmi.toString().indexOf('.') != -1 && !isNaN(d.bmi) && d.bmi.toString().indexOf('.') != -1){
                      var personneTemp = new Personne(d["v2_age"], d.bmi);
                      personnes.push(personneTemp);
                  }
              });
              personnes.sort(function(a, b) {
                  return a.x - b.x;
              })
              makeAverage(personnes);
              myDataIsReady();

            }
          });
      });
      */

      function makeAverage(tabToMakeAverage){
          var currentAge = tabToMakeAverage[0].x;
          personnes = []
          var counter = 1;
          var sum = tabToMakeAverage[0].y;
          for (var key in tabToMakeAverage){
              var ageCour = tabToMakeAverage[key].x;
              var imcCour = tabToMakeAverage[key].y;
              if (ageCour != currentAge){
                  personnes.push({x: currentAge, y: sum / counter});
                  currentAge = ageCour;
                  sum = imcCour;
                  counter = 1;
              }else{
                  sum += imcCour;
                  counter++;
              }
          }
      }

      var color = Chart.helpers.color;
      var config = {

        type: 'line',
        data: {
          datasets: [{
            label: "Data Gouv INCA2",
            borderColor: window.chartColors.red,
            backgroundColor: color(window.chartColors.red).alpha(0.2).rgbString(),
            data: personnes
          }]
        },
        options: {
             //responsive: true,
             tooltips: {
                 mode: 'index',
                 intersect: false,
             },
             hover: {
                 mode: 'nearest',
                 intersect: true
             },
             scales: {
                 xAxes: [{
                     display: true,
                     scaleLabel: {
                         display: true,
                         labelString: 'Age'
                     }
                 }],
                 yAxes: [{
                     display: true,
                     scaleLabel: {
                         display: true,
                         labelString: 'IMC'
                     }
                 }]
             }
         }
      };


      function myDataIsReady() {
          console.log(personnes);
          var ctx = document.getElementById("lineChart").getContext("2d");
          //window.myLine = new Chart(ctx, config);

          window.myScatter = Chart.Scatter(ctx,{

            type: 'line',
            data: {
              datasets: [{
                label: "Data Gouv INCA2",
                borderColor: window.chartColors.black,
                backgroundColor: color(window.chartColors.black).alpha(0.9).rgbString(),
                data: personnes
              }]
            },
            options: {
                 /*responsive: true,
                 title:{
                     display:true,
                     text:'IMC en fonction de l\'âge',
                     fontSize: '29'
                     font
                 },*/
                 tooltips: {
                     mode: 'index',
                     intersect: false,
                 },
                 hover: {
                     mode: 'nearest',
                     intersect: true
                 },
                 scales: {
                     xAxes: [{
                         display: true,
                         scaleLabel: {
                             display: true,
                             labelString: 'Age'
                         }
                     }],
                     yAxes: [{
                         display: true,
                         scaleLabel: {
                             display: true,
                             labelString: 'IMC'
                         }
                     }]
                 }
             }
          }
        );
      };

  </script>
</body>
</html>
